<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}" lang="en">
<head>
    <meta charset="UTF-8">
    <title>무인양품 김포점</title>
</head>
<style>

</style>
<body>

<div class="container" layout:fragment="content">

    <div>
        <input type="hidden" id="article-id" th:value="${article.id}">
        <div th:text="${article.title}"></div>
        <div th:utext="${article.content}"></div>
        <div th:text="${article.writer}"></div>
        <div th:text="${#temporals.format(article.createdAt, 'yyyy-MM-dd HH:mm')}"></div>
    </div>
    <div th:with="link = ${pageRequestDTO.getLink()}">
        <button type="button" th:onclick="|location.href='@{/newArticle?id={articleId}(articleId=${article.id})}'|">수정</button>
        <button type="button" class="article-delete-btn">삭제</button>
        <a th:href="|@{/articles}?${link}|">
            <button type="button" class="article-delete-btn">리스트</button>
        </a>
    </div>

    <div>
        <div>
            <textarea name="comment" class="comment-textArea" placeholder="댓글 작성"></textarea>
            <input name="author" class="comment-author" type="text">
            <button type="button" class="addCommentBtn">댓글 달기</button>
        </div>
        <ul class="comment-list">

        </ul>
        <ul class="commentPagination">

        </ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/article.js"></script>
    <script src="/js/comment.js"></script>

    <script layout:fragment="script" th:inline="javascript">

        const $articleId = [[${article.id}]]
        const $article = [[${article}]]
        console.log($article);

        const commentList = document.querySelector('.comment-list')
        const commentPaging = document.querySelector('.commentPagination')

        function printCommentList(dtoList){

            console.log(dtoList)

            let str = '';

            if (dtoList && dtoList.length > 0){

                for (const dto of dtoList){

                    str += `<li class="commentItem">
                                <span>${dto.id}</span>
                                <span>${dto.comment}</span>
                                <span>${dto.author}</span>
                                <span>${dto.createdAt}</span>
                            </li>`

                }
            }
            commentList.innerHTML = str
        }

        function printPage(data){

            let pageStr = '';

            if (data.prev){
                pageStr += `<li><a class="comment-page-link" data-page="${data.start -1}">PREV</a></li>`
            }

            for (let i = data.start; i <= data.end; i++){
                pageStr += `<li class="page-item ${i == data.page ? "active" : ""}">
                                <a data-page="${i}">${i}</a>
                            </li>`
            }

            if (data.next){
                pageStr += `<li><a data-page="${data.end +1}">NEXT</a></li>`
            }
            commentPaging.innerHTML = pageStr
        }

        function printComment(page, size, goLast){

            console.log("page: " + page)
            console.log("size: " + size)

            getList({$articleId, page, size, goLast}).then(
                data => {
                    printCommentList(data.dtoList)
                    printPage(data)
                }
            ).catch(e => {
                console.error(e)
            })
        }

        printComment(1, 10, true)


        //  리플 달기
        const $addCommentBtn = document.querySelector('.addCommentBtn')
        const $comment = document.querySelector('.comment-textArea')
        const $author = document.querySelector('.comment-author')

        if ($addCommentBtn){
            $addCommentBtn.addEventListener('click', function (e){
                const commentObj = {
                    articleId: $articleId,
                    comment: $comment.value,
                    author: $author.value
                }
                addComment(commentObj).then(result => {
                    $comment.value = ''
                    $author.value = ''
                    printComment(1, 10, true)
                }).catch(e => {
                    alert("Exception....")
                })
            }, false)
        }

        let page = 1
        let size = 10

        commentPaging.addEventListener('click', function (e){

            e.preventDefault()
            e.stopPropagation()

            const target = e.target

            if (!target || target.tagName != 'A'){
                return
            }

            const pageNum = target.getAttribute("data-page")
            page = pageNum
            printComment(page, size)

        }, false)


    </script>
</div>




</body>
</html>